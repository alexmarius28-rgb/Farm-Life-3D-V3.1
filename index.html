<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Farm Life 3D">
    <meta name="theme-color" content="#1e3c72">
    <title>Farm Simulator 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
                        /* Enhanced wood style for all buttons */
                        button, .btn, .ui-button {
                            background:
                                linear-gradient(180deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.08) 30%, transparent 60%),
                                url('https://www.transparenttextures.com/patterns/wood.png'),
                                linear-gradient(135deg, #7c4a1e 0%, #a0522d 40%, #deb887 100%);
                            background-blend-mode: overlay, multiply;
                            color: #fff8e1;
                            border: 2.5px solid #6b3e1d;
                            border-radius: 14px;
                            box-shadow:
                                0 4px 0 #6b3e1d,
                                0 1.5px 8px #00000033,
                                inset 0 2px 8px #fffbe6cc,
                                inset 0 -2px 12px #a0522d99;
                            font-family: 'Fredoka One', 'Nunito', 'Segoe UI', sans-serif;
                            font-weight: bold;
                            text-shadow: 1px 1px 2px #6b3e1d99, 0 2px 6px #fffbe6cc;
                            letter-spacing: 0.5px;
                            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
                            position: relative;
                            overflow: hidden;
                        }
                        button::after, .btn::after, .ui-button::after {
                            content: '';
                            position: absolute;
                            left: 8%;
                            top: 8%;
                            width: 84%;
                            height: 30%;
                            background: linear-gradient(90deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.08) 100%);
                            border-radius: 8px 8px 40% 40%;
                            pointer-events: none;
                            z-index: 2;
                        }
                        button:hover, .btn:hover, .ui-button:hover {
                            background:
                                linear-gradient(180deg, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.12) 30%, transparent 60%),
                                url('https://www.transparenttextures.com/patterns/wood.png'),
                                linear-gradient(135deg, #a0522d 0%, #deb887 60%, #ffe4b5 100%);
                            box-shadow: 0 6px 0 #6b3e1d, 0 2px 12px #00000044, inset 0 2px 12px #fffbe6cc;
                            color: #fffbe6;
                            transform: translateY(-2px) scale(1.04);
                        }
                        button:active, .btn:active, .ui-button:active {
                            background:
                                linear-gradient(180deg, rgba(255,255,255,0.10) 0%, rgba(255,255,255,0.04) 30%, transparent 60%),
                                url('https://www.transparenttextures.com/patterns/wood.png'),
                                linear-gradient(135deg, #6b3e1d 0%, #a0522d 60%, #deb887 100%);
                            box-shadow: 0 2px 0 #6b3e1d, 0 1px 4px #00000022, inset 0 1px 6px #fffbe6cc;
                            color: #ffe4b5;
                            transform: translateY(2px) scale(0.98);
                        }
                .profile-owner {
                    background: linear-gradient(135deg, #fffbe6, #f1c40f 60%);
                    box-shadow: 0 0 16px 2px #f1c40f44;
                }
                .profile-admin {
                    background: linear-gradient(135deg, #eaf6ff, #3498db 60%);
                    box-shadow: 0 0 16px 2px #3498db44;
                }
                .profile-vip {
                    background: linear-gradient(135deg, #ffeaf6, #e91e63 60%, #f1c40f 100%);
                    box-shadow: 0 0 16px 2px #e91e6344;
                }
        :root {
            --zynga-blue: #0099ff;
            --zynga-blue-dark: #0066cc;
            --zynga-gold: #ffcc00;
            --zynga-gold-dark: #ff9900;
            --zynga-red: #ff3333;
            --zynga-red-dark: #cc0000;
            --zynga-green: #66cc33;
            --zynga-green-dark: #339900;
        }
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Fredoka One', 'Nunito', 'Segoe UI', sans-serif;
            background: linear-gradient(120deg, #1e3c72, #2a5298);
            background-size: 200% 200%;
            animation: bgShift 12s ease-in-out infinite;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        @keyframes bgShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .speech-bubble {
            position: absolute;
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            pointer-events: none;
            transform: translate(-50%, -120%);
            max-width: 160px;
            text-align: center;
        }
        .crop-timer {
            position: absolute;
            transform: translate(-50%, -130%);
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .crop-timer .timer-content {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            border-radius: 12px;
            padding: 4px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s ease;
            position: relative;
        }

        .crop-timer .timer-circle {
            position: relative;
            width: 32px;
            height: 32px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .crop-timer .timer-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 32px;
            height: 32px;
            transform: rotate(-90deg);
        }
        .crop-timer .timer-bg {
            stroke: rgba(255,255,255,0.15);
            stroke-width: 4;
        }
        .crop-timer .timer-fg {
            stroke: #f1c40f;
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s linear;
        }
        .crop-timer.ripe .timer-fg {
            stroke: #2ecc71;
        }
        .crop-timer .timer-center-icon {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            pointer-events: none;
        }

        .crop-timer .timer-text {
            color: white;
            font-family: 'Segoe UI', sans-serif;
            font-size: 10px;
            font-weight: 700;
            white-space: nowrap;
            letter-spacing: 0.5px;
        }

        .crop-timer .timer-bar-bg {
            width: 24px;
            height: 3px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1px;
        }

        .crop-timer .timer-bar-fill {
            height: 100%;
            background: #f1c40f;
            width: 0%;
            border-radius: 2px;
        }

        /* Ripe State */
        .crop-timer.ripe .timer-content {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border-color: #2ecc71;
            padding: 6px 12px;
            flex-direction: row;
            gap: 6px;
            animation: pulse-ripe 1.5s infinite;
        }

        .crop-timer.ripe .timer-text {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 800;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .crop-timer.ripe .timer-bar-bg {
            display: none;
        }
        
        .crop-timer.ripe .timer-icon {
            font-size: 14px;
            display: block;
        }

        @keyframes pulse-ripe {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(46, 204, 113, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }
        #game-container {
            width: 100vw;
            height: 100vh;
            display: block;
            user-select: none; /* Prevent selection in game */
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none; /* Hidden initially */
            z-index: 1000;
        }
        .ui-panel {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px;
        }
        /* MOBILE HUD LAYOUT */
        #hud-top-left {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            z-index: 100;
        }
        #hud-top-right {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            pointer-events: none;
            z-index: 100;
        }
        
        /* Stats Styling */
        .hud-stat-row {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            padding: 5px 15px 5px 5px;
            border-radius: 50px;
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            font-family: 'Fredoka One', cursive;
            pointer-events: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            min-width: 120px;
        }
        .hud-stat-row:hover {
            transform: scale(1.05);
        }
        .hud-icon-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid white;
            flex-shrink: 0;
        }
        .hud-value {
            font-size: 18px;
            text-shadow: 0 2px 0 rgba(0,0,0,0.3);
            flex-grow: 1;
            text-align: right;
        }
        
        /* Money Specific */
        .stat-money .hud-icon-circle { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .stat-money { border-color: #f39c12; }
        
        /* Level Specific */
        .stat-level .hud-icon-circle { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stat-level { border-color: #2980b9; }

        /* Generic Round Button */
        .round-hud-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.4);
            transition: all 0.1s;
            pointer-events: auto;
            position: relative;
            background: linear-gradient(to bottom, var(--zynga-blue), var(--zynga-blue-dark));
        }
        .round-hud-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        
        .btn-settings { background: linear-gradient(to bottom, #95a5a6, #7f8c8d); }
        .btn-leaderboard { background: linear-gradient(to bottom, var(--zynga-gold), var(--zynga-gold-dark)); }
        .btn-map { background: linear-gradient(to bottom, var(--zynga-green), var(--zynga-green-dark)); }
        .btn-updates { background: linear-gradient(to bottom, #8e44ad, #9b59b6); }
        
        /* Remove Old Top Bar Styles if present (overwriting visually) */
        #top-bar { display: none !important; } 

        /* Adjust Right Bar */
        #right-bar {
            position: absolute;
            top: unset;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column-reverse; /* Grow upwards */
            align-items: flex-end;
            pointer-events: none; /* Container passes clicks */
        }
        #right-bar > * {
            pointer-events: auto; /* Children capture clicks */
            margin-top: 10px;
        }
        
        #move-btn {
            pointer-events: auto !important;
            z-index: 1001 !important;
        }
        
        #left-sidebar {
            position: absolute;
            top: 280px;
            left: 10px;
            width: 250px; /* Slightly wider for modern look */
            pointer-events: none;
            z-index: 900;
        }

        #mission-panel {
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 0; /* Connected look */
            transition: all 0.3s ease;
        }

        #mission-toggle-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 14px 24px;
            border-radius: 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 16px rgba(231, 76, 60, 0.4), inset 0 1px 0 rgba(255,255,255,0.3);
            width: fit-content;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            z-index: 2;
            position: relative;
        }
        #mission-toggle-btn::before {
            content: '‚≠ê';
            font-size: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        #mission-toggle-btn:hover {
            transform: scale(1.08) translateY(-2px);
            box-shadow: 0 12px 24px rgba(231, 76, 60, 0.6), inset 0 1px 0 rgba(255,255,255,0.4);
            background: linear-gradient(135deg, #ec7063, #cb4335);
        }
        #mission-toggle-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.4), inset 0 1px 0 rgba(255,255,255,0.3);
        }

        #mission-content {
            background: rgba(44, 62, 80, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 8px;
        }

        #mission-content.expanded {
            max-height: 320px;
            opacity: 1;
            transform: translateY(0) scale(1);
            padding: 12px;
        }

        .mission-header {
            font-family: 'Fredoka One', cursive;
            color: #f1c40f;
            margin-bottom: 10px;
            font-size: 18px;
            text-shadow: 0 2px 0 rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            padding-bottom: 5px;
        }

        #mission-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Missions layout: button slightly up, content goes downward */
        #mission-panel { position: relative; }
        #mission-toggle-btn { position: relative; margin-top: 24px; }

        /* Mission Item Styling - Override or New */
        .mission-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            border-left: 4px solid #f1c40f;
        }
        .zoom-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .zoom-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 15px;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 0 #1f618d, 0 5px 10px rgba(0,0,0,0.3);
            transition: all 0.1s;
            margin-bottom: 5px; /* Space for shadow */
            text-shadow: 0 2px 0 rgba(0,0,0,0.2);
            -webkit-tap-highlight-color: transparent;
        }
        .zoom-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #1f618d, 0 8px 15px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }
        .zoom-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #1f618d;
        }

        .action-btn {
            background: linear-gradient(to bottom, var(--zynga-blue), var(--zynga-blue-dark));
            border: 3px solid white;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Fredoka One', cursive;
            text-align: center;
            box-shadow: 0 5px 0 rgba(0,0,0,0.3);
            transition: all 0.1s;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            width: 100%;
            margin-bottom: 10px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .action-btn:hover { 
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 rgba(0,0,0,0.3);
        }
        .action-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 rgba(0,0,0,0.3);
        }



        #controls-area {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            width: 80%;
            max-width: 800px;
            pointer-events: auto; /* Allow clicks on child elements */
            z-index: 1000;
        }
        .shop-trigger-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: linear-gradient(to bottom, var(--zynga-red), var(--zynga-red-dark));
            color: white;
            border: none;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            font-family: 'Fredoka One', cursive;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 8px 0 #990000, 0 10px 20px rgba(0,0,0,0.4);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 4px solid white;
            pointer-events: auto;
            text-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        .shop-trigger-btn:hover {
            transform: translateX(-50%) translateY(-5px) scale(1.1);
            box-shadow: 0 12px 0 #990000, 0 20px 30px rgba(0,0,0,0.5);
        }
        .shop-trigger-btn:active {
            transform: translateX(-50%) translateY(4px);
            box-shadow: 0 0 0 #990000;
        }
        /* Chat beside Shop */
        #chat-btn {
            position: absolute;
            bottom: 20px;
            left: calc(50% + 130px);
            z-index: 999;
            background: linear-gradient(135deg, #3b5998, #1e3799);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 6px 0 #0b2545, 0 10px 20px rgba(0,0,0,0.4);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: auto;
            font-size: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
        }
        #chat-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 9px 0 #0b2545, 0 16px 26px rgba(0,0,0,0.5);
            filter: brightness(1.1);
        }
        #chat-btn:active {
            transform: translateY(3px) scale(0.98);
            box-shadow: 0 2px 0 #0b2545;
        }
        /* Admin & Owner beside Chat */
        #admin-btn, #owner-btn {
            position: absolute;
            bottom: 20px;
            z-index: 999;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 6px 0 rgba(0,0,0,0.4), 0 10px 20px rgba(0,0,0,0.4);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: auto;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
        }
        #admin-btn {
            left: calc(50% + 205px);
            background: linear-gradient(135deg, #2980b9, #2471a3);
        }
        #owner-btn {
            left: calc(50% + 280px);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        #admin-btn:hover, #owner-btn:hover {
            transform: translateY(-3px) scale(1.05);
            filter: brightness(1.05);
        }
        #admin-btn:active, #owner-btn:active {
            transform: translateY(3px) scale(0.98);
            box-shadow: 0 2px 0 rgba(0,0,0,0.4);
        }
        #chat-panel {
            position: absolute;
            bottom: 110px;
            left: calc(50% + 120px);
            width: 300px;
            max-height: 320px;
            display: none;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 16px;
            backdrop-filter: blur(6px);
            border: 2px solid rgba(255,255,255,0.25);
            overflow: hidden;
            z-index: 1000;
            pointer-events: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(59, 89, 152, 0.8), rgba(30, 55, 153, 0.7));
            color: white;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        #chat-messages {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow-y: auto;
            max-height: 220px;
            font-size: 13px;
            color: #ecf0f1;
        }
        .chat-msg {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 6px 8px;
            border-radius: 8px;
        }
        #chat-input-area {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.4);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        #chat-input {
            flex: 1;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 13px;
        }
        #chat-send-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 0 3px 0 #196f3d;
            font-weight: 800;
        }
        #chat-send-btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
        #chat-send-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #196f3d; }
        /* Mobile adjustments */
        @media (max-width: 480px) {
            #chat-btn {
                left: calc(50% + 95px);
                width: 52px;
                height: 52px;
                font-size: 22px;
            }
            #admin-btn {
                left: calc(50% + 155px);
                width: 52px;
                height: 52px;
                font-size: 20px;
            }
            #owner-btn {
                left: calc(50% + 210px);
                width: 52px;
                height: 52px;
                font-size: 20px;
            }
            #chat-panel {
                left: calc(50% + 90px);
                width: 260px;
                max-height: 280px;
            }
            /* Mobile button sizing */
            button, .btn {
                min-width: 44px;
                min-height: 44px;
                font-size: 14px;
            }
            input, textarea {
                font-size: 16px;
                padding: 12px;
            }
            /* Safe area insets for notched devices */
            #move-btn {
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }
        /* Mobile-friendly touch targets */
        @media (hover: none) and (pointer: coarse) {
            button, .ui-button, .btn {
                min-width: 48px !important;
                min-height: 48px !important;
            }
            /* Increase padding for touch */
            .ui-panel {
                border-radius: 16px;
            }
        }
        .close-shop-btn {
            position: absolute;
            top: -15px;
            right: -15px;
            background: #e74c3c;
            color: white;
            border: 2px solid white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1001;
        }
        .close-shop-btn:hover {
            transform: scale(1.1);
            background: #c0392b;
        }
        #shop-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 0;
            pointer-events: auto;
            padding-left: 10px;
        }
        .tab-btn {
            background: linear-gradient(to bottom, #eeeeee, #cccccc);
            color: #555;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 15px 15px 0 0;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            margin-bottom: -5px; /* Overlap with content */
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        .tab-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
        }
        .tab-btn.active {
            background: linear-gradient(to bottom, var(--zynga-gold), var(--zynga-gold-dark));
            color: white;
            border: 2px solid white;
            border-bottom: none;
            box-shadow: 0 -4px 10px rgba(241, 196, 15, 0.3);
            transform: scale(1.1);
            z-index: 10;
        }
        #build-menu {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            overflow-y: auto;
            max-height: 340px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            pointer-events: auto;
            width: 100%;
            scrollbar-width: thin;
        }
        #build-menu::-webkit-scrollbar { width: 6px; }
        #build-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        /* Obsolete but kept for safety - updated style */
        .build-btn {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            font-size: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .build-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .build-btn.active { background: #e2a04a; }
        .build-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Start Screen */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            pointer-events: auto;
            overflow: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .auth-bg-decoration {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: float 20s infinite ease-in-out;
            top: -100px;
            right: -100px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(30px) rotate(180deg); }
        }

        #start-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 60px 50px;
            text-align: center;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            max-width: 480px;
            width: 90%;
            pointer-events: auto;
            color: white;
            z-index: 10;
            position: relative;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-container {
            margin-bottom: 30px;
        }

        .title-anim {
            font-size: 48px;
            margin: 0 0 10px 0;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .auth-tab {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .auth-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .auth-tab.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab-icon {
            font-size: 18px;
        }

        .modern-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #auth-form input,
        #create-form input,
        #reset-form input {
            padding: 16px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        #auth-form input::placeholder,
        #create-form input::placeholder,
        #reset-form input::placeholder {
            color: #999;
        }

        #auth-form input:focus,
        #create-form input:focus,
        #reset-form input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
            background: white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .auth-message {
            color: #ff6b6b;
            font-size: 13px;
            margin: 5px 0;
            min-height: 18px;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .auth-message.success {
            color: #51cf66;
        }

        button.start-btn {
            padding: 16px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin-top: 5px;
        }

        button.start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        button.start-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .auth-footer {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .footer-link {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .footer-link:hover {
            color: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
          }
        .auth-tab {
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .auth-tab.active {
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.5);
            border-color: #f1c40f;
        }

        /* Modern Notification System */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 9999;
            pointer-events: none;
            perspective: 1000px;
        }

        .notification-toast {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(15px);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 320px;
            max-width: 400px;
            box-shadow: 
                0 10px 25px rgba(0,0,0,0.5),
                0 0 0 1px rgba(255,255,255,0.1);
            transform: translateX(120%) rotateY(-20deg);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            border-left: 5px solid #3498db;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            position: relative;
            transform-style: preserve-3d;
        }

        .notification-toast.show {
            transform: translateX(0) rotateY(0deg);
        }

        /* 3D Depth Layer */
        .notification-toast::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .notification-toast.error {
            border-left-color: #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.15), rgba(30,30,30,0.95) 25%);
        }

        .notification-toast.success {
            border-left-color: #2ecc71;
            background: linear-gradient(90deg, rgba(46, 204, 113, 0.15), rgba(30,30,30,0.95) 25%);
        }

        .notification-toast.warning {
            border-left-color: #f1c40f;
            background: linear-gradient(90deg, rgba(241, 196, 15, 0.15), rgba(30,30,30,0.95) 25%);
        }

        .notification-icon {
            font-size: 28px;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transform: translateZ(10px);
        }

        .notification-content {
            flex: 1;
            z-index: 1;
            transform: translateZ(5px);
        }

        .notification-title {
            font-weight: 800;
            font-size: 15px;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .notification-msg {
            font-size: 13px;
            color: #bdc3c7;
            line-height: 1.4;
            font-weight: 500;
        }

        .notification-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            transition: all 0.2s;
            z-index: 2;
            transform: translateZ(15px);
        }
        
        .notification-close:hover {
            color: white;
            transform: translateZ(20px) scale(1.2);
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.2);
            width: 100%;
        }

        .notification-progress-bar {
            height: 100%;
            background: inherit;
            width: 100%;
            transform-origin: left;
            animation: progress-shrink linear forwards;
        }

        .notification-toast.error .notification-progress-bar { background: #e74c3c; }
        .notification-toast.success .notification-progress-bar { background: #2ecc71; }
        .notification-toast.warning .notification-progress-bar { background: #f1c40f; }

        @keyframes progress-shrink {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }

        /* XP Bar - Integrated into HUD */
        #xp-container {
            position: relative;
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: visible;
            margin-top: 4px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }
        #xp-bar {
            height: 100%;
            background: linear-gradient(90deg, #00b09b, #96c93d);
            width: 0%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        #xp-text {
            /* Hidden by default, show on hover */
            display: none; 
        }
        .stat-level:hover #xp-text {
            display: block;
            position: absolute;
            top: 10px;
            right: 0;
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
        }

        /* Inventory */
        #inventory-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }
        .inventory-card {
            background: linear-gradient(135deg, #4a90e2, #357abd);
            border: 2px solid #fff;
            border-radius: 12px;
            padding: 10px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .inventory-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .inventory-icon {
            font-size: 36px;
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }
        .inventory-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            line-height: 24px;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .inventory-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .inventory-value {
            font-size: 12px;
            color: #f1c40f;
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }
        #inventory-total {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        /* Upgrade Menu Styles */
        .upgrade-req-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            text-align: left;
        }
        .upgrade-req-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .upgrade-req-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }
        .upgrade-req-info {
            flex-grow: 1;
        }
        .upgrade-req-name {
            display: block;
            font-weight: bold;
            font-size: 14px;
            color: #ecf0f1;
        }
        .upgrade-req-count {
            display: block;
            font-size: 12px;
            color: #bdc3c7;
        }
        .upgrade-status-icon {
            font-size: 18px;
        }
        .upgrade-cost-display {
            font-size: 18px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(44, 62, 80, 0.95);
            padding: 30px;
            border-radius: 15px;
            color: white;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            min-width: 350px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            touch-action: pan-y;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        .modal h2 {
            margin-top: 0;
            color: #f1c40f;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #bdc3c7;
            font-size: 20px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover { 
            color: white; 
            background: #e74c3c;
            transform: rotate(90deg);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        tr:hover { background: #f5f5f5; }
        .farm-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modern Profile Styles - REPLACED BY NEWER DEFINITIONS BELOW */


        .profile-btn-modern {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: all 0.1s;
            text-transform: uppercase;
            font-size: 12px;
            pointer-events: auto;
        }
        .profile-btn-modern:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .profile-btn-modern:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }
        .profile-btn-modern:active:hover {
            transform: translateY(4px);
        }
        .p-icon {
            font-size: 18px;
        }

        .tool-btn {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 5px 0 #687677;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .tool-btn:hover {
            background: linear-gradient(135deg, #aab7b8, #95a5a6);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #687677;
        }
        .tool-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #687677;
        }
        
        .tool-btn.active-move {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 5px 0 #2980b9;
        }
        .tool-btn.active-move:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
            box-shadow: 0 7px 0 #2980b9;
        }
        .tool-btn.active-move:active {
            box-shadow: 0 0 0 #2980b9;
        }

        .tool-btn.active-sell {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 5px 0 #c0392b;
        }
        .tool-btn.active-sell:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            box-shadow: 0 7px 0 #c0392b;
        }
        .tool-btn.active-sell:active {
            box-shadow: 0 0 0 #c0392b;
        }

        .backpack-3d-btn {
            background: linear-gradient(135deg, #e67e22, #d35400);
            border: 2px solid #ba4a00;
            border-bottom: 6px solid #ba4a00;
            border-radius: 15px;
            width: 100%;
            padding: 5px 0;
            font-size: 32px;
            color: white;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 5px 15px rgba(211, 84, 0, 0.4);
            text-align: center;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .backpack-3d-btn:active {
            border-bottom: 2px solid #ba4a00;
            transform: translateY(4px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .backpack-3d-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .backpack-3d-btn:active:hover {
            transform: translateY(4px);
        }

        /* Modern Profile Window */
        .profile-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            text-align: left;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
        }
        .profile-avatar-large {
            font-size: 50px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .profile-title h3 { margin: 0; font-size: 24px; color: white; }
        .profile-subtitle { color: #bdc3c7; font-size: 14px; margin-top: 5px; }
        
        .profile-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .profile-stat-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .profile-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            margin-top: 5px;
        }
        .profile-stat-label {
            font-size: 12px;
            color: #bdc3c7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .profile-actions {
            margin-top: 10px;
        }
        .expand-btn-modern {
            width: 100%;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .expand-btn-modern:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .farm-card:hover { background: #e9e9e9; }
        #credits {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.4);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
        }

        /* NEW SHOP STYLES */
        .shop-card {
            background: linear-gradient(145deg, #34495e, #2c3e50);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px 8px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 95px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .shop-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.05) 0%, transparent 100%);
            pointer-events: none;
        }
        .shop-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            z-index: 10;
            background: linear-gradient(145deg, #3e5871, #2c3e50);
            border-color: rgba(255,255,255,0.2);
        }
        .shop-card.active {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border: none;
            color: #2c3e50;
            transform: scale(1.03) translateY(-3px);
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.5);
            z-index: 11;
        }
        .shop-card.active .shop-cost {
            background: rgba(255,255,255,0.3);
            color: #2c3e50;
        }
        .shop-tag {
            display: inline-block;
            margin-top: 3px;
            padding: 2px 6px;
            font-size: 9px;
            border-radius: 10px;
            background: rgba(255,255,255,0.15);
            color: #ecf0f1;
        }
        .shop-card.locked {
            background: linear-gradient(145deg, #2c3e50, #2c3e50);
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
            box-shadow: none;
        }
        .shop-icon {
            font-size: 32px;
            margin-bottom: 4px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
            transition: transform 0.3s;
        }
        .shop-card:hover .shop-icon {
            transform: scale(1.08);
        }
        .shop-info {
            text-align: center;
            width: 100%;
        }
        .shop-name {
            font-weight: 700;
            font-size: 12px;
            margin-bottom: 2px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            line-height: 1.2;
        }
        .shop-cost {
            font-size: 11px;
            color: #f1c40f; /* Gold */
            font-weight: 800;
            background: rgba(0,0,0,0.4);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        .shop-desc {
            font-size: 9px;
            color: #bdc3c7;
            margin-top: 2px;
            font-style: italic;
            display: none; /* Hide description to keep it clean, or show on hover? */
        }
        .shop-card:hover .shop-desc,
        .shop-card.active .shop-desc {
            display: block;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .shop-search {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.15);
            color: white;
            outline: none;
        }
        .shop-search::placeholder { color: rgba(255,255,255,0.7); }
        .shop-sort {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.15);
            color: white;
            outline: none;
        }

        /* Auth Styles */
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .auth-tab {
            background: rgba(255,255,255,0.1);
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .auth-tab.active {
            background: #f1c40f;
            color: #2c3e50;
            transform: scale(1.05);
        }
        #auth-form input {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.9);
            font-size: 16px;
        }
        /* MOBILE RESPONSIVE STYLES */
        @media (max-width: 768px) {
            #hud-top-left {
                transform: scale(0.9);
                transform-origin: top left;
                left: 10px;
                top: 10px;
            }
            #hud-top-right {
                transform: scale(0.9);
                transform-origin: top right;
                right: 10px;
                top: 10px;
            }
            #xp-container {
                width: 90%;
                top: 80px;
            }
            #controls-area {
                width: 95%;
                bottom: 90px;
            }
            .shop-card {
                min-width: 100px; /* Allow smaller cards */
                padding: 10px;
            }
            .shop-icon { font-size: 32px; }
            .shop-name { font-size: 13px; }
            .modal {
                width: 95%;
                padding: 20px;
            }
            #left-sidebar {
                top: 120px;
                width: 180px;
            }
        }

        @media (max-width: 480px) {
            #hud-top-left {
                transform: scale(0.8);
                gap: 5px;
            }
            #hud-top-right {
                transform: scale(0.85);
                gap: 5px;
            }
            .round-hud-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            .shop-trigger-btn {
                width: 65px;
                height: 65px;
                bottom: 15px;
            }
            .shop-trigger-btn span { font-size: 20px !important; }
            
            #right-bar {
                right: 10px;
                bottom: 15px;
                transform: scale(0.9);
                transform-origin: bottom right;
            }
            
            .backpack-3d-btn { width: 50px !important; height: 50px !important; font-size: 24px !important; }
            .tool-btn { width: 50px !important; height: 50px !important; }
            .tool-btn span { font-size: 20px !important; }
            .action-btn, .profile-btn-modern { width: 50px !important; height: 50px !important; }
            .action-btn span, .profile-btn-modern span { font-size: 20px !important; }
            
            #controls-area { bottom: 85px; }
            #shop-tabs .tab-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            /* Compact Mission List */
            #mission-list {
                width: 160px;
                font-size: 12px;
                padding: 8px;
            }
            
            /* Start Screen Mobile */
            #start-card { padding: 25px; }
            h1.title-anim { font-size: 24px; }
            .auth-tabs { flex-direction: column; gap: 5px; }
            .auth-tab { width: 100%; text-align: center; }
            button.start-btn { padding: 12px 30px; font-size: 16px; }
        }
    </style>
    <style>
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(0, 0, 0, 0.25);
            padding: 8px;
            border-radius: 16px;
            backdrop-filter: blur(4px);
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .control-group:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255,255,255,0.2);
        }

        /* Tutorial Styles */
        #tutorial-overlay {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.95);
            padding: 20px;
            border-radius: 15px;
            color: white;
            z-index: 1500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 2px solid #f1c40f;
            text-align: center;
            min-width: 300px;
            display: none;
            animation: bounceIn 0.5s;
        }
        @keyframes bounceIn {
            0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
        #tutorial-text {
            font-size: 16px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        #tutorial-next-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }
        #tutorial-next-btn:hover {
            transform: scale(1.05);
            background: #27ae60;
        }
        #tutorial-skip-btn {
            background: transparent;
            color: #95a5a6;
            border: none;
            font-size: 12px;
            margin-top: 10px;
            cursor: pointer;
            text-decoration: underline;
        }
        #tutorial-skip-btn:hover { color: #bdc3c7; }
        .tutorial-highlight {
            box-shadow: 0 0 20px #f1c40f !important;
            border: 2px solid #f1c40f !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
    <style id="wood-button-style">
    button, .btn, .ui-button {
        background: url('https://www.transparenttextures.com/patterns/wood-pattern.png'), linear-gradient(135deg, #a0522d 60%, #deb887 100%) !important;
        background-blend-mode: multiply !important;
        color: #fff8e1 !important;
        border: 2px solid #8b5c2a !important;
        box-shadow: 0 4px 0 #7c4a1e, 0 1px 8px #00000033 !important;
        font-family: 'Fredoka One', 'Nunito', 'Segoe UI', sans-serif !important;
        font-weight: bold !important;
        text-shadow: 1px 1px 2px #6b3e1d99 !important;
        transition: background 0.2s, box-shadow 0.2s, transform 0.1s !important;
    }
    button:hover, .btn:hover, .ui-button:hover {
        background: url('https://www.transparenttextures.com/patterns/wood-pattern.png'), linear-gradient(135deg, #b87333 60%, #ffe4b5 100%) !important;
        box-shadow: 0 6px 0 #7c4a1e, 0 2px 12px #00000044 !important;
        color: #fffbe6 !important;
        transform: translateY(-2px) scale(1.04) !important;
    }
    button:active, .btn:active, .ui-button:active {
        background: url('https://www.transparenttextures.com/patterns/wood-pattern.png'), linear-gradient(135deg, #8b5c2a 60%, #deb887 100%) !important;
        box-shadow: 0 2px 0 #7c4a1e, 0 1px 4px #00000022 !important;
        color: #ffe4b5 !important;
        transform: translateY(2px) scale(0.98) !important;
    }
    </style>
<body>
    <div id="game-container"></div>
    
    <div id="start-screen">
        <div id="start-card">
            <div class="logo-container">
                <h1 class="title-anim">üöú Farm Life 3D</h1>
                <p class="subtitle">Build Your Digital Farm</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthMode('login')">
                    <span class="tab-icon">üîì</span>
                    <span>Login</span>
                </button>
                <button class="auth-tab" onclick="switchAuthMode('create')">
                    <span class="tab-icon">‚ú®</span>
                    <span>Create</span>
                </button>
                <button class="auth-tab" onclick="switchAuthMode('reset')">
                    <span class="tab-icon">üîë</span>
                    <span>Reset</span>
                </button>
            </div>

            <div id="auth-form" class="modern-form">
                <!-- Login Form -->
                <div id="login-form" class="auth-section">
                    <input type="text" id="auth-username" placeholder="Username" maxlength="15" autocomplete="username">
                    <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
                    <div id="auth-message" class="auth-message"></div>
                    <button class="start-btn" onclick="handleAuthSubmit()">Log In</button>
                </div>

                <!-- Create Account Form -->
                <div id="create-form" class="auth-section" style="display: none;">
                    <input type="text" id="create-username" placeholder="Choose Username" maxlength="15">
                    <input type="email" id="create-email" placeholder="Email Address" required>
                    <input type="password" id="create-password" placeholder="Password (min 6 chars)">
                    <input type="password" id="create-confirm" placeholder="Confirm Password">
                    <div id="create-message" class="auth-message"></div>
                    <button class="start-btn" onclick="handleCreateAccount()">Create Account</button>
                </div>

                <!-- Reset Password Form -->
                <div id="reset-form" class="auth-section" style="display: none;">
                    <input type="text" id="reset-username" placeholder="Username">
                    <input type="email" id="reset-email" placeholder="Email Address" required>
                    <div id="reset-message" class="auth-message"></div>
                    <button class="start-btn" onclick="handleResetPassword()">Send Reset Link</button>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">
                        Check your email for password reset instructions
                    </p>
                </div>
            </div>

            <div id="version-display" style="margin-top: 20px; font-size: 11px; color: rgba(255,255,255,0.4); text-align: center; font-family: monospace;"></div>
            
            <div class="auth-footer">
                <a href="javascript:showGameGuide()" class="footer-link">üìñ How to Play</a>
                <a href="javascript:void(0)" class="footer-link">‚öôÔ∏è Settings</a>
            </div>
        </div>

        <!-- Background decoration -->
        <div class="auth-bg-decoration"></div>
    </div>

    <div id="ui-layer">
        <div id="username-badge" style="position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 8px; color: white; font-weight: bold; font-size: 14px; border: 2px solid #667eea;">
            üë§ <span id="player-name-display">Player</span>
        </div>

        <div id="hud-top-left">
            <div class="hud-stat-row stat-level" onclick="showProfile()">
                <div class="hud-icon-circle">
                    <span style="font-size: 20px;">‚≠ê</span>
                </div>
                <div class="hud-value">
                    <div style="font-size: 10px; opacity: 0.8;">LEVEL</div>
                    <span id="level-display">1</span>
                    <div id="xp-container">
                        <div id="xp-bar"></div>
                        <div id="xp-text">0 / 100 XP</div>
                    </div>
                </div>
            </div>
            
            <div class="hud-stat-row stat-money">
                <div class="hud-icon-circle">
                    <span style="font-size: 20px;">üí∞</span>
                </div>
                <div class="hud-value">
                    <div style="font-size: 10px; opacity: 0.8;">BALANCE</div>
                    <span id="money-display">0</span>
                </div>
            </div>
            
            <div class="hud-stat-row stat-money" style="background: rgba(0,0,0,0.6);">
                <div class="hud-icon-circle" style="background: #9b59b6;">
                    <span style="font-size: 20px;">üíé</span>
                </div>
                <div class="hud-value">
                    <div style="font-size: 10px; opacity: 0.8;">DIAMONDS</div>
                    <span id="diamonds-display">1000</span>
                </div>
            </div>

            <div class="hud-stat-row stat-money" style="background: rgba(0,0,0,0.6);">
                <div class="hud-icon-circle" style="background: #f1c40f;">
                    <span style="font-size: 20px;">‚ö°</span>
                </div>
                <div class="hud-value">
                    <div style="font-size: 10px; opacity: 0.8;">POWER</div>
                    <div id="power-container" style="width: 100px; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; margin-top: 5px; position: relative; overflow: hidden;">
                        <div id="power-bar" style="width: 0%; height: 100%; background: #f1c40f; transition: width 0.3s;"></div>
                    </div>
                    <div id="power-text" style="font-size: 10px; margin-top: 2px;">0 / 0 KW</div>
                </div>
            </div>

            <!-- Mini stats row -->
            <div style="display: flex; gap: 5px;">
                <div class="hud-stat-row" style="min-width: auto; padding: 5px 10px; display:flex; align-items:center; gap:8px;">
                    <span id="day-icon-span" style="font-size: 16px; margin-right: 5px;">‚òÄÔ∏è</span>
                    <span id="day-display" style="font-size: 14px;">Day</span>
                    <span id="clock-display" style="font-size:12px; opacity:0.85; margin-left:6px;">--:--:--</span>
                </div>
                <div class="hud-stat-row" style="min-width: auto; padding: 5px 10px;">
                    <span style="font-size: 16px; margin-right: 5px;">‚õÖ</span>
                    <span id="weather-display" style="font-size: 14px;">Sunny</span>
                </div>
            </div>
        </div>

        <div id="hud-top-right">
            <button class="round-hud-btn" onclick="document.getElementById('ai-chat-modal').style.display='block'" title="AI Chat Support">ü§ñ</button>
            <button class="round-hud-btn" onclick="showTutorial()" title="3D Tutorial">üéì</button>
            <button class="round-hud-btn btn-map" onclick="showWorldMap()" title="World Map">üåç</button>
            <button class="round-hud-btn btn-leaderboard" onclick="showLeaderboard()" title="Leaderboard">üèÜ</button>
            <button class="round-hud-btn btn-settings" onclick="showSettings()" title="Settings">‚öôÔ∏è</button>
            <button class="round-hud-btn btn-updates" onclick="showUpdates()" title="Updates" style="background: linear-gradient(135deg, #8e44ad, #9b59b6);">üì∞</button>
        <button id="vip-panel-btn" style="display:none; margin-left: 8px; background: linear-gradient(135deg, #e91e63, #f1c40f); color: #fff; border-radius: 15px; width: 50px; height: 50px; font-size: 18px; border: none; cursor: pointer; align-items: center; justify-content: center;" onclick="window.showVIPPanel()" title="VIP Panel">
            <span style="font-size: 24px;">üíé</span>
        </button>
        </div>

        <div id="left-sidebar">
            <div id="mission-panel">
                <button id="mission-toggle-btn" onclick="toggleMissions()">
                    <span style="font-size: 24px;">üìú</span>
                    <span class="btn-text">MISSIONS</span>
                </button>
                <div id="mission-content" class="expanded">
                    <div class="mission-header">Current Goals</div>
                    <div id="mission-list">
                        <!-- JS injected missions -->
                    </div>
                </div>
            </div>
        </div>

    <div id="right-bar" class="ui-panel" style="background:transparent; padding:0; box-shadow:none;">
        <!-- Zoom Group -->
        <div class="control-group" style="pointer-events: auto !important;">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="zoomOut()">-</button>
        </div>

        <!-- Tools Group -->
        <div class="control-group">
            <!-- Rotate Button integrated here -->
            <button id="rotate-btn" onclick="try { window.rotateBuilding(); } catch(e) { console.error('rotateBuilding error:', e); }" style="
                display: none; /* Controlled by JS */
                width: 50px;
                height: 50px;
                background: linear-gradient(135deg, #f39c12, #d35400);
                color: white;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                box-shadow: 0 4px 0 #ba4a00;
                transition: all 0.1s;
                display: flex;
                align-items: center;
                justify-content: center;
            " title="Rotate Object">
                <span style="font-size: 24px;">üîÑ</span>
            </button>

            <button id="sell-btn" class="tool-btn" onclick="try { window.toggleSellMode(); } catch(e) { console.error('toggleSellMode error:', e); }" style="width: 50px; height: 50px; border-radius: 15px; padding: 0 !important;" title="Sell Mode">
                <span style="font-size: 24px;">üí≤</span>
            </button>
        </div>

        <!-- Actions Group -->
        <div class="control-group">
            <button class="backpack-3d-btn" onclick="showInventory()" style="width: 50px; height: 50px; border-radius: 15px; font-size: 24px; padding: 0;" title="Inventory">üéí</button>
            
            <button class="action-btn" onclick="expandFarm()" style="background: linear-gradient(135deg, #27ae60, #2ecc71); width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; padding: 0;" title="Expand Farm">
                <span style="font-size: 24px;">üìê</span>
            </button>
            
            <button class="profile-btn-modern" onclick="showGuide()" style="background: linear-gradient(135deg, #3498db, #2980b9); width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; padding: 0;" title="Help">
                <span style="font-size: 24px;">‚ùì</span>
            </button>
        </div>
    </div>


        <!-- VIP Panel Button: Only visible to VIPs and Owner -->
        <button id="vip-panel-btn" style="display:none; margin-right: 8px; background: linear-gradient(135deg, #e91e63, #f1c40f); color: #fff; border-radius: 15px; width: 50px; height: 50px; font-size: 18px; border: none; cursor: pointer; align-items: center; justify-content: center;" onclick="window.showVIPPanel()" title="VIP Panel">
            <span style="font-size: 24px;">üíé</span> VIP
        </button>

        <button class="shop-trigger-btn" onclick="toggleShop()">
            <span style="font-size: 24px;">üè™</span> SHOP
        </button>

        <!-- Chat Button & Panel -->
        <button id="chat-btn" onclick="toggleChat()">üí¨</button>
        <!-- Admin & Owner Buttons -->
        <button id="admin-btn" onclick="window.openAdminPanel()" title="Admin">üõ°Ô∏è</button>
        <button id="owner-btn" onclick="window.openOwnerPanel()" title="Owner">üëë</button>
        <div id="chat-panel">
            <div id="chat-header">
                <span>GLOBAL CHAT</span>
                <button onclick="toggleChat()" style="background:none;border:none;color:white;cursor:pointer;font-size:16px;">‚úï</button>
            </div>
            <div id="chat-messages">
                <div class="chat-msg" style="color:#bdc3c7; text-align:center; font-style:italic;">Welcome to Global Chat!</div>
            </div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type a message..." maxlength="100" autocomplete="off">
                <button id="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>

        <div id="controls-area">
             <!-- Shop Tabs -->
            <div style="position: relative; width: 100%; display: flex; flex-direction: column; align-items: center;">
                <button class="close-shop-btn" onclick="toggleShop()">‚úï</button>
                
                <div id="shop-tabs">
                    <button class="tab-btn active" onclick="setShopCategory('crop')">Seeds</button>
                    <button class="tab-btn" onclick="setShopCategory('tree')">Trees</button>
                    <button class="tab-btn" onclick="setShopCategory('plot')">Plots</button>
                    <button class="tab-btn" onclick="setShopCategory('building')">Buildings</button>
                    <button class="tab-btn" onclick="setShopCategory('decoration')">Decorations</button>
                    <button class="tab-btn" onclick="setShopCategory('vehicle')">Vehicles</button>
                    <button class="tab-btn" onclick="setShopCategory('animal')">Animals</button>
                </div>
                <div style="margin: 8px 0; pointer-events: auto;">
                    <label style="color:white; font-size: 12px;">
                        <input type="checkbox" id="pay-diamonds-toggle" onchange="togglePayWithDiamonds(this.checked)" />
                        Pay with Diamonds for items
                    </label>
                </div>
                <div style="display:flex; gap:10px; width:100%; padding:0 10px; pointer-events:auto; align-items:center; justify-content:space-between;">
                    <input id="shop-search" class="shop-search" type="text" placeholder="Search items..." oninput="setShopSearchTerm(this.value)">
                    <select id="shop-sort" class="shop-sort" onchange="setShopSort(this.value)">
                        <option value="name_asc">Name</option>
                        <option value="price_asc">Price ‚Üë</option>
                        <option value="price_desc">Price ‚Üì</option>
                        <option value="level_asc">Level</option>
                    </select>
                </div>
                <div id="build-menu" class="ui-panel">
                    <!-- Dynamic Buttons -->
                </div>
                <div style="margin-top:8px; display:flex; justify-content:flex-end; pointer-events:auto;">
                    <button class="action-btn" onclick="showCatalogue()" style="background: linear-gradient(135deg, #34495e, #2c3e50);">Catalogue</button>
                </div>
            </div>
        </div>
    </div>

    <div id="credits">Coded by Alex</div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="modal">
        <button class="modal-close" onclick="closeModal('leaderboard-modal')">&times;</button>
        <h2>Top Farmers</h2>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Level</th>
                    <th>Money</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <!-- JS injected -->
            </tbody>
        </table>
    </div>

    <!-- World Map Modal -->
    <div id="world-map-modal" class="modal">
        <button class="modal-close" onclick="closeModal('world-map-modal')">&times;</button>
        <h2>Visit Neighbors</h2>
        <div id="farm-list">
            <!-- JS injected -->
        </div>
    </div>
    
    <div id="profile-modal" class="modal">
        <button class="modal-close" onclick="closeModal('profile-modal')">&times;</button>
        <h2>Your Profile</h2>
        <div id="profile-content"></div>
    </div>
    <div id="catalogue-modal" class="modal">
        <button class="modal-close" onclick="closeModal('catalogue-modal')">&times;</button>
        <h2>Catalogue</h2>
        <div id="catalogue-content"></div>
    </div>
    <div id="inventory-modal" class="modal">
        <button class="modal-close" onclick="closeModal('inventory-modal')">&times;</button>
        <h2>Inventory</h2>
        <div id="inventory-content"></div>
        <button class="action-btn" onclick="sellInventory()">Sell All</button>
    </div>

    <div id="house-upgrade-modal" class="modal">
        <button class="modal-close" onclick="closeModal('house-upgrade-modal')">&times;</button>
        <h2>Main House Upgrade</h2>
        <div id="house-upgrade-content"></div>
        <br>
        <button id="house-upgrade-btn" class="action-btn" onclick="upgradeHouseAction()">Upgrade</button>
    </div>

    <!-- Animal Building Modal -->
    <div id="animal-building-modal" class="modal">
        <button class="modal-close" onclick="closeModal('animal-building-modal')">&times;</button>
        <h2 id="animal-modal-title">Building</h2>
        <div id="animal-modal-content"></div>
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
            <button id="animal-collect-btn" class="action-btn" onclick="collectAnimalProduct()" style="display:none; background: linear-gradient(135deg, #2ecc71, #27ae60);">Collect</button>
            <button id="animal-upgrade-btn" class="action-btn" onclick="upgradeAnimalBuilding()">Upgrade</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <button class="modal-close" onclick="closeModal('settings-modal')">&times;</button>
        <h2 style="color: #3498db; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 20px;">‚öôÔ∏è Settings</h2>
        
        <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
            <div style="margin-bottom: 25px;">
                <h3 style="color: #f1c40f; display: flex; align-items: center; gap: 8px;">üîä Audio</h3>
                <button class="action-btn" id="audio-btn" onclick="toggleAudio()" style="width: 100%; background: linear-gradient(135deg, #9b59b6, #8e44ad);">üîà Audio: On</button>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="color: #2ecc71; display: flex; align-items: center; gap: 8px;">üé® Graphics Quality</h3>
                <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                    <button class="action-btn" onclick="setGraphicsQuality('low', this)" style="flex: 1; background: linear-gradient(135deg, #95a5a6, #7f8c8d);">üí® Smooth</button>
                    <button class="action-btn" onclick="setGraphicsQuality('medium', this)" style="flex: 1; background: linear-gradient(135deg, #f1c40f, #f39c12);">üìä Medium</button>
                    <button class="action-btn" onclick="setGraphicsQuality('high', this)" style="flex: 1; background: linear-gradient(135deg, #3498db, #2980b9);">üéØ High</button>
                    <button class="action-btn" onclick="setGraphicsQuality('ultra', this)" style="flex: 1; background: linear-gradient(135deg, #8e44ad, #9b59b6);">‚ú® Ultra</button>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #1abc9c; display: flex; align-items: center; gap: 8px;">üåê Online & Social</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="action-btn" onclick="showMultiplayerOptions()" style="background: linear-gradient(135deg, #3498db, #2980b9);">üéÆ Multiplayer</button>
                    <button class="action-btn" onclick="showFriendsList()" style="background: linear-gradient(135deg, #e91e63, #c2185b);">üë• Friends</button>
                    <button class="action-btn" onclick="showGlobalLeaderboard()" style="background: linear-gradient(135deg, #f1c40f, #f39c12); grid-column: 1 / -1;">üèÜ Leaderboard</button>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #e74c3c; display: flex; align-items: center; gap: 8px;">üí¨ Feedback & Support</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="action-btn" onclick="showFeedbackModal()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">üìù Send Feedback</button>
                    <button class="action-btn" onclick="showBugReportModal()" style="background: linear-gradient(135deg, #c0392b, #a93226);">üêõ Report Bug</button>
                </div>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: #3498db; display: flex; align-items: center; gap: 8px;">üë§ Account</h3>
                <button class="action-btn" onclick="showRedeemModal()" style="width: 100%; background: linear-gradient(135deg, #ff9ff3, #f368e0); margin-bottom: 10px;">
                    üéüÔ∏è Redeem Codes
                </button>
                <button class="action-btn" onclick="saveGame(); showNotification('Game saved!', 'success');" style="width: 100%; background: linear-gradient(135deg, #a0522d, #deb887); color: #fff8e1; font-weight: bold; margin-bottom: 10px;">
                    üíæ Save Game
                </button>
                <button class="action-btn" onclick="logout()" style="width: 100%; background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    üö™ Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="modal">
        <button class="modal-close" onclick="closeModal('feedback-modal')">&times;</button>
        <h2 style="color: #9b59b6;">üìù Send Feedback</h2>
        <form onsubmit="submitFeedback(event)" style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Feedback Type:</label>
                <select id="feedback-type" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #3498db; background: rgba(52, 152, 219, 0.1); color: white;">
                    <option value="suggestion">üí° Suggestion</option>
                    <option value="feature">‚ú® Feature Request</option>
                    <option value="gameplay">üéÆ Gameplay</option>
                    <option value="other">üí¨ Other</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Your Feedback:</label>
                <textarea id="feedback-text" placeholder="Tell us what you think..." style="width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 2px solid #3498db; background: rgba(52, 152, 219, 0.1); color: white; font-family: inherit; resize: vertical;" required></textarea>
            </div>
            <button type="submit" class="action-btn" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">‚úâÔ∏è Send Feedback</button>
        </form>
    </div>

    <!-- Bug Report Modal -->
    <div id="bug-report-modal" class="modal">
        <button class="modal-close" onclick="closeModal('bug-report-modal')">&times;</button>
        <h2 style="color: #c0392b;">üêõ Report Bug</h2>
        <form onsubmit="submitBugReport(event)" style="display: flex; flex-direction: column; gap: 15px;">
            <div>
                <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Bug Title:</label>
                <input type="text" id="bug-title" placeholder="Brief description of the bug" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.1); color: white;" required>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Steps to Reproduce:</label>
                <textarea id="bug-steps" placeholder="Describe how to reproduce the bug..." style="width: 100%; height: 100px; padding: 10px; border-radius: 8px; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.1); color: white; font-family: inherit; resize: vertical;" required></textarea>
            </div>
            <div>
                <label style="display: block; margin-bottom: 5px; color: #ecf0f1;">Expected vs Actual:</label>
                <textarea id="bug-expected" placeholder="What should happen vs what actually happens..." style="width: 100%; height: 80px; padding: 10px; border-radius: 8px; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.1); color: white; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <button type="submit" class="action-btn" style="background: linear-gradient(135deg, #c0392b, #a93226);">üêõ Submit Report</button>
        </form>
    </div>

    <!-- Multiplayer Modal -->
    <div id="multiplayer-modal" class="modal">
        <button class="modal-close" onclick="closeModal('multiplayer-modal')">&times;</button>
        <h2 style="color: #3498db;">üéÆ Multiplayer Options</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="background: rgba(52, 152, 219, 0.1); border-left: 4px solid #3498db; padding: 15px; border-radius: 8px;">
                <h3 style="color: #3498db; margin-top: 0;">Connection Status</h3>
                <p id="mp-status" style="margin: 10px 0 0 0; font-size: 14px;">üî¥ Offline - Tap to connect</p>
            </div>
            <button class="action-btn" onclick="connectToServer()" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">üîó Connect Online</button>
            <button class="action-btn" onclick="showVisitFarmUI()" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">üë• Visit Friend's Farm</button>
            <button class="action-btn" onclick="toggleCoop()" id="coop-toggle-btn" style="background: linear-gradient(135deg, #f1c40f, #f39c12);">ü§ù Co-op Mode</button>
        </div>
    </div>

    <!-- AI Chat Support Modal -->
    <div id="ai-chat-modal" class="modal" style="width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        <button class="modal-close" onclick="closeModal('ai-chat-modal')">&times;</button>
        <h2 style="color: #667eea; margin-bottom: 15px;">ü§ñ AI Assistant - Farming Help</h2>
        
        <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; max-height: 400px;">
            <div style="background: rgba(102, 126, 234, 0.2); padding: 12px; border-radius: 10px; text-align: left;">
                <strong style="color: #667eea;">ü§ñ AI:</strong> Hello farmer! I'm here to help. Ask me about farming tips, what crops to plant, how to make money, or anything about the game!
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <input type="text" id="ai-chat-input" placeholder="Ask me anything about farming..." style="flex: 1; padding: 12px; border-radius: 10px; border: 2px solid #667eea; background: rgba(102, 126, 234, 0.1); color: white; font-size: 14px;">
            <button onclick="sendAIMessage()" class="action-btn" style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 12px 20px; width: auto;">Send</button>
        </div>
        
        <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 10px; text-align: center;">
            üí° Try asking: "best crops for money", "how to get diamonds", "animal breeding tips"
        </div>
    </div>

    <!-- 3D Tutorial Modal -->
    <div id="tutorial-modal" class="modal" style="max-width: 700px;">
        <button class="modal-close" onclick="closeTutorial()">&times;</button>
        <h2 style="color: #f1c40f;">üéì 3D Farm Tutorial</h2>
        
        <div id="tutorial-content" style="display: flex; flex-direction: column; gap: 20px;">
            <!-- Tutorial Steps -->
            <div id="tutorial-step-1" class="tutorial-step">
                <h3 style="color: #f1c40f; margin-top: 0;">Welcome to Farm Life 3D! üöú</h3>
                <p>You now have your own 3D farm! Here's how to get started:</p>
                <p style="background: rgba(241, 196, 15, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #f1c40f;">
                    <strong>Goal:</strong> Build and manage your farm, grow crops, raise animals, and earn money and diamonds!
                </p>
            </div>

            <div id="tutorial-step-2" class="tutorial-step" style="display: none;">
                <h3 style="color: #3498db;">üìç Basic Controls</h3>
                <ul style="line-height: 2;">
                    <li><strong>üñ±Ô∏è Rotate View:</strong> Click and drag with your mouse to rotate the camera</li>
                    <li><strong>üîç Zoom:</strong> Use the mouse wheel to zoom in/out</li>
                    <li><strong>üåæ Place Items:</strong> Click on items in the shop, then click on your farm</li>
                    <li><strong>‚úã Move Items:</strong> Click the Move button (‚úã), then click and drag objects</li>
                    <li><strong>üí≤ Sell Items:</strong> Click the Sell button (üí≤), then click objects to sell them</li>
                </ul>
            </div>

            <div id="tutorial-step-3" class="tutorial-step" style="display: none;">
                <h3 style="color: #2ecc71;">üå± Planting & Harvesting</h3>
                <p><strong>How to Plant:</strong></p>
                <ol style="line-height: 2;">
                    <li>Open the Shop (üè™)</li>
                    <li>Select a seed under "Seeds" tab</li>
                    <li>Click on your farm to plant</li>
                    <li>Wait for it to grow (check the timer above)</li>
                    <li>Click to harvest when ready!</li>
                </ol>
                <p style="background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 8px;">
                    üí° Tip: Plant expensive seeds in groups for more profit!
                </p>
            </div>

            <div id="tutorial-step-4" class="tutorial-step" style="display: none;">
                <h3 style="color: #9b59b6;">üêî Animals & Buildings</h3>
                <p><strong>How to Raise Animals & Use NPCs:</strong></p>
                <ol style="line-height: 2;">
                    <li>Build animal structures (Barn, Coop, Pig Pen)</li>
                    <li>Buy animals from the Shop (Animals tab) or spawn them near the building</li>
                    <li>Animals produce resources over time (eggs, milk, truffles)</li>
                    <li>NPC farmers can collect those resources automatically ‚Äî place at least one <strong>House</strong> to spawn farmers</li>
                    <li>Open the <strong>NPC Panel</strong> to see pending collections and farmer status</li>
                </ol>
                <p><strong>Example Production:</strong> Chickens ‚Üí Eggs, Cows ‚Üí Milk, Pigs ‚Üí Truffles</p>
                <p style="background: rgba(155, 89, 182, 0.06); padding: 8px; border-radius: 8px;">Tip: NPCs require Houses and will walk to pickups‚Äîwatch them collect and return items to inventory.</p>
            </div>

            <div id="tutorial-step-5" class="tutorial-step" style="display: none;">
                <h3 style="color: #e74c3c;">üí∞ Making Money</h3>
                <p><strong>Ways to Earn Money & Diamonds:</strong></p>
                <ul style="line-height: 1.8;">
                    <li>‚úÖ <strong>Sell Crops:</strong> Harvest and click the Sell button (üí≤) or sell via Inventory</li>
                    <li>‚úÖ <strong>NPC Collection:</strong> NPC farmers collect eggs, milk and truffles when you have Houses</li>
                    <li>‚úÖ <strong>Complete Missions:</strong> Check your mission list (‚≠ê)</li>
                    <li>‚úÖ <strong>Daily Bonuses:</strong> Log in daily for rewards</li>
                    <li>‚úÖ <strong>Decorations:</strong> Some give bonuses to production</li>
                </ul>
            </div>

            <div id="tutorial-step-6" class="tutorial-step" style="display: none;">
                <h3 style="color: #16a085;">üè† Upgrading & Expanding</h3>
                <p><strong>How to Grow Your Farm:</strong></p>
                <ol style="line-height: 2;">
                    <li>Click your Main House to upgrade it</li>
                    <li>Unlock new buildings and crops at higher levels</li>
                    <li>Click the Expand (üìê) button to expand your farm</li>
                    <li>Expand multiple times to create a huge farm!</li>
                </ol>
                <p style="background: rgba(22, 160, 133, 0.1); padding: 10px; border-radius: 8px;">
                    Each upgrade gives you more building space and unlocks new items!
                </p>
            </div>

            <div id="tutorial-step-7" class="tutorial-step" style="display: none;">
                <h3 style="color: #f39c12;">‚≠ê Tips for Success</h3>
                <ul style="line-height: 2; background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px;">
                    <li>üéØ Focus on missions to earn diamonds</li>
                    <li>üå§Ô∏è Weather affects growth - rain helps crops grow faster</li>
                    <li>üîÑ Plant fast-growing crops for quick cash</li>
                    <li>üì¶ Use storage buildings (Silo, Warehouse) wisely</li>
                    <li>‚ö° Build generators for consistent production</li>
                    <li>ü§ñ Ask the AI Assistant if you get stuck!</li>
                </ul>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
            <button class="action-btn" id="tutorial-prev-btn" onclick="previousTutorialStep()" style="background: rgba(100,100,100,0.5); width: 100px;">‚¨ÖÔ∏è Back</button>
            <span id="tutorial-progress" style="display: flex; align-items: center; color: rgba(255,255,255,0.6);">1 / 7</span>
            <button class="action-btn" id="tutorial-next-btn" onclick="nextTutorialStep()" style="background: linear-gradient(135deg, #f1c40f, #f39c12); width: 100px;">Next ‚û°Ô∏è</button>
        </div>
        
        <button class="action-btn" onclick="closeTutorial()" style="background: rgba(100,100,100,0.5); width: 100%; margin-top: 10px;">Skip Tutorial</button>
    </div>

    <!-- Updates Modal -->
    <div id="updates-modal" class="modal">
        <button class="modal-close" onclick="closeModal('updates-modal')">&times;</button>
        <h2>Latest Updates</h2>
        <div id="updates-content" style="text-align: left; max-height: 400px; overflow-y: auto; padding: 10px;">
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #ffb300; font-size: 2em; font-family: 'Fredoka One', cursive; text-align: center; margin-bottom: 20px;">Latest Updates</h3>
            </div>
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #00bfff; margin-bottom: 5px;">v3.1 - Cartoonish 3D Sun & Realistic Rain Effects</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 31, 2025</div>
                <div style="font-size: 14px; opacity: 0.95; padding-left: 6px; line-height: 1.6;">
                    <strong>Visual Enhancements:</strong>
                    <ul style="margin-top:6px; padding-left:18px;">
                        <li>‚òÄÔ∏è <b>Cartoonish Sun Redesign:</b> Added expressive sun with big white eyes, black pupils, rosy cheeks, orange nose, friendly red smile, enhanced golden rays with rounded tips, and sparkle particles orbiting it.</li>
                        <li>üåßÔ∏è <b>Realistic Rain System:</b> Switched to line-segment rain streaks (3‚Äì5 units long) that fall naturally using subtle gray-blue coloring for immersion.</li>
                        <li>üíß <b>Persistent Puddles:</b> Rain creates puddles on terrain with reflective water material; puddles persist ~30s and fade out, accumulating opacity on repeated hits.</li>
                        <li>üå± <b>Crop Visibility & Scaling:</b> Crops now occupy the full plot and are vertically adjusted and scaled so all crop types remain clearly visible above soil.</li>
                    </ul>
                    <strong style="display:block; margin-top:8px;">Technical Details:</strong>
                    <ul style="margin-top:6px; padding-left:18px;">
                        <li>Sun: 2 eyes with pupils, 2 rosy cheeks, orange nose, 7-part smile arc, 12 dynamic rounded rays, and 50 sparkle particles.</li>
                        <li>Rain: Implemented with <code>THREE.LineSegments</code> for falling streak geometry and improved physics/rendering.</li>
                        <li>Puddles: Persistent CircleGeometry meshes with a 30s lifespan, fade system, and grid-based deduplication; opacity increases with multiple hits.</li>
                        <li>Crop Rendering: Adjusted vertical positioning and scaling to avoid clipping and ensure maximum visibility for all crop models.</li>
                    </ul>
                    <div style="margin-top:8px; opacity:0.9;">Status: ‚úÖ All visual updates tested and working</div>
                </div>
            </div>
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #00bfff; margin-bottom: 5px;">v3.0 - Previous Update</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 30, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üå¶Ô∏è <b>Major Visual Update:</b> See v3.1 for details.</li>
                </ul>
            </div>
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #3498db; margin-bottom: 5px;">v2.9 - Move Mode & Button Fixes</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 29, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>‚úã <b>Move Button Overhaul:</b> Completely redesigned move button with dynamic JavaScript creation for better reliability.</li>
                    <li>üéÆ <b>Dynamic Button Creation:</b> Button is now created at runtime with proper event listeners in capture phase.</li>
                    <li>üèóÔ∏è <b>Move Mode Fixed:</b> Buildings can now be clicked, selected, and dragged to new locations with grid snapping.</li>
                    <li>üé® <b>Visual Feedback:</b> Selected buildings rise up and become semi-transparent while moving. Green outline = valid placement.</li>
                </ul>
            </div>
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #558b2f; margin-bottom: 5px;">v2.6 - Realistic Update</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 28, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üåø <b>3D Grass:</b> Replaced flat ground with lush, instanced 3D grass blades for a natural look.</li>
                    <li>üéÖ <b>New Decorations:</b> Garden Gnomes, Rock Clusters, Flower Beds, Bonfires, Gazebos, and the legendary Golden Cow!</li>
                    <li>üìè <b>Precision Building:</b> Smarter grid snapping ensures perfect alignment for buildings of all sizes.</li>
                    <li>üèóÔ∏è <b>Visual Fixes:</b> Windmills and other structures adjusted for better appearance and clipping fixes.</li>
                </ul>
            </div>
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #e74c3c; margin-bottom: 5px;">v2.5 - Construction Update</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 28, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üèóÔ∏è <b>Better Building:</b> Added a green grid marker when placing buildings to show exactly where they will go.</li>
                    <li>üî¥ <b>Smart Collision:</b> The marker turns red if you try to build on top of something else.</li>
                    <li>üí® <b>Fixed Windmills:</b> Windmill blades no longer clip through the roof and have been extended for a better look.</li>
                </ul>
            </div>
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #3498db; margin-bottom: 5px;">v2.9 - Move Mode & Button Fixes</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 29, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>‚úã <b>Move Button Overhaul:</b> Completely redesigned move button with dynamic JavaScript creation for better reliability.</li>
                    <li>üéÆ <b>Dynamic Button Creation:</b> Button is now created at runtime with proper event listeners in capture phase.</li>
                    <li>üèóÔ∏è <b>Move Mode Fixed:</b> Buildings can now be clicked, selected, and dragged to new locations with grid snapping.</li>
                    <li>üé® <b>Visual Feedback:</b> Selected buildings rise up and become semi-transparent while moving. Green outline = valid placement.</li>
                    <li>üîß <b>Always Accessible:</b> Move button positioned on right-side HUD controls (next to zoom buttons) for easy access.</li>
                    <li>üìç <b>Smart Placement:</b> Grid-snap ensures buildings align perfectly. Red outline indicates collision/invalid placement.</li>
                    <li>üêõ <b>Debug Logging:</b> Console messages help track button creation and building selection for troubleshooting.</li>
                </ul>
            </div>
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #f1c40f; margin-bottom: 5px;">v2.8 - Shop & Systems</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 28, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üè™ <b>Shop Redesign:</b> Modern grid layout with cleaner cards and vertical scrolling.</li>
                    <li>üîé <b>Search & Sort:</b> Quickly find items and sort by Name, Price, or Level.</li>
                    <li>üêæ <b>Animals Tab:</b> Dedicated shop tab for purchasing animals for breeding.</li>
                    <li>üíï <b>Breeding Center:</b> New building for breeding; animals must be in a Breeding Center.</li>
                    <li>üìö <b>Catalogue Modal:</b> Browse all items and icons across categories in a quick grid.</li>
                    <li>üí≤ <b>Sell Mode Fix:</b> Upgradable buildings like Warehouse, Silo, Generator, and Solar can be sold.</li>
                    <li>üì¶ <b>Stacked Storage:</b> Inventory capacity stacks with multiple Silos and Warehouses.</li>
                    <li>‚ö° <b>Stacked Power:</b> Electricity production stacks across Generators and Solar panels with a live HUD.</li>
                </ul>
            </div>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 28, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>‚ú® <b>Visual Overhaul:</b> Removed 3D grass for a cleaner look and added "Ecstatic" tiles with gold frames and magic gems!</li>
                    <li>üè° <b>Modern Main House:</b> Completely redesigned main house with an L-shaped layout, porch, and detailed siding.</li>
                    <li>üöú <b>Alive Vehicles:</b> Vehicles now drive autonomously! Click them to honk, jump, and get a speed boost.</li>
                    <li>üîê <b>3D Login:</b> A stunning new 3D login screen with floating cards, pop-out inputs, and immersive notifications.</li>
                    <li>üîß <b>Core Fixes:</b> Fixed crop harvesting logic, tree fruit yields, and balanced the economy.</li>
                </ul>
            </div>

            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #558b2f; margin-bottom: 5px;">v2.6 - Realistic Update</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 28, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üåø <b>3D Grass:</b> Replaced flat ground with lush, instanced 3D grass blades for a natural look.</li>
                    <li>üéÖ <b>New Decorations:</b> Garden Gnomes, Rock Clusters, Flower Beds, Bonfires, Gazebos, and the legendary Golden Cow!</li>
                    <li>üìè <b>Precision Building:</b> Smarter grid snapping ensures perfect alignment for buildings of all sizes.</li>
                    <li>üèóÔ∏è <b>Visual Fixes:</b> Windmills and other structures adjusted for better appearance and clipping fixes.</li>
                </ul>
            </div>

            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #e74c3c; margin-bottom: 5px;">v2.5 - Construction Update</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 28, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üèóÔ∏è <b>Better Building:</b> Added a green grid marker when placing buildings to show exactly where they will go.</li>
                    <li>üî¥ <b>Smart Collision:</b> The marker turns red if you try to build on top of something else.</li>
                    <li>üí® <b>Fixed Windmills:</b> Windmill blades no longer clip through the roof and have been extended for a better look.</li>
                    <li>üêõ <b>Bug Fixes:</b> Fixed a critical issue that prevented the game from loading, and cleaned up UI code.</li>
                </ul>
            </div>

            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #2ecc71; margin-bottom: 5px;">v2.4 - Living Farm Update</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 25, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üí® <b>Dynamic Animations:</b> Windmills spin, fans rotate, and weather vanes sway in the wind!</li>
                    <li>üå´Ô∏è <b>Particle Effects:</b> Chimneys and tractors now emit realistic smoke puffs.</li>
                    <li>üåä <b>Water Ripples:</b> Ponds and fountains now feature animated water surfaces.</li>
                    <li>üöú <b>New Models:</b> Detailed Tractor with exhaust and animated Scarecrow added.</li>
                </ul>
            </div>

            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #e74c3c; margin-bottom: 5px;">v2.3 - Graphics Overhaul</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 25, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üé® <b>Modern 3D Graphics:</b> All assets upgraded to PBR (Physically Based Rendering) Standard Materials for realistic lighting and textures.</li>
                    <li>üå≤ <b>Enhanced Vegetation:</b> Crops and trees now feature dynamic growth scaling, improved models, and correct planting elevations.</li>
                    <li>üß± <b>New Textures:</b> High-quality textures for plots, paths, and decorations.</li>
                    <li>üå§Ô∏è <b>Lighting & Shadows:</b> Improved shadow casting and receiving for all structures.</li>
                    <li>üõ†Ô∏è <b>Polished Visuals:</b> Fixed visual glitches (z-fighting) and improved building detail alignment.</li>
                    <li>üèóÔ∏è <b>Detailed Models:</b> Silos, barns, houses, fences, and vehicles have been completely remodeled.</li>
                </ul>
            </div>

            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #9b59b6; margin-bottom: 5px;">v2.2 - Daily Missions</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 25, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üìÖ <b>Daily Missions:</b> 6 new random missions every day!</li>
                    <li>üîÑ <b>300+ Variations:</b> Huge variety of tasks including harvesting, planting, selling, and more.</li>
                    <li>‚è±Ô∏è <b>24h Cooldown:</b> Missions refresh automatically every 24 hours.</li>
                    <li>üí∞ <b>New Rewards:</b> Earn Money and XP from completing daily tasks.</li>
                </ul>
            </div>

            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #9b59b6; margin-bottom: 5px;">v2.1 - UI Improvements</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 25, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>‚≠ê <b>XP Bar Integration:</b> The XP bar is now neatly integrated into the Level HUD for a cleaner look.</li>
                    <li>üñ±Ô∏è <b>Hover Details:</b> Hover over your level to see exact XP progress.</li>
                    <li>‚è≥ <b>Slower Weather:</b> Rain and snow now fall slower, and weather patterns last twice as long (8 days).</li>
                    <li>üì∞ <b>Updates Log:</b> Added this changelog window so you can track game updates!</li>
                </ul>
            </div>

            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #f1c40f; margin-bottom: 5px;">v2.0 - Weather Update</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 25, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üåßÔ∏è <b>Realistic Weather:</b> Added detailed rain splashes, snow accumulation, and fluffy clouds.</li>
                    <li>üí° <b>Visibility Fixes:</b> Improved lighting during storms so you can see your farm better.</li>
                    <li>‚è≥ <b>Slower Transitions:</b> Weather changes are now smoother and less frequent (every 4 days).</li>
                    <li>üé® <b>Graphics Overhaul:</b> Enhanced particle effects and sky rendering.</li>
                </ul>
            </div>
            
            <div class="update-item" style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px;">
                <h3 style="color: #3498db; margin-bottom: 5px;">v1.5 - Missions & Shop</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">December 10, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üìú <b>Daily Missions:</b> Complete tasks to earn XP and rewards.</li>
                    <li>üè™ <b>Shop Expansion:</b> Added new decorations and building types.</li>
                    <li>üîÑ <b>Rotation Tool:</b> You can now rotate buildings before placing them.</li>
                </ul>
            </div>

            <div class="update-item">
                <h3 style="color: #2ecc71; margin-bottom: 5px;">v1.0 - Initial Release</h3>
                <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">November 1, 2025</div>
                <ul style="font-size: 14px; opacity: 0.9; padding-left: 20px; line-height: 1.6;">
                    <li>üöú <b>Farm Life Begins:</b> Plant crops, raise animals, and build your dream farm!</li>
                    <li>üåç <b>World Map:</b> Visit other players' farms.</li>
                    <li>üèÜ <b>Leaderboard:</b> Compete for the top spot.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Redeem Code Modal -->
    <div id="redeem-modal" class="modal">
        <button class="modal-close" onclick="closeModal('redeem-modal')">&times;</button>
        <h2>Redeem Code</h2>
        <div style="margin-bottom: 20px;">
            <p>Enter your code below to claim rewards!</p>
            <input type="text" id="redeem-input" placeholder="ENTER CODE" style="
                width: 80%;
                padding: 10px;
                font-size: 16px;
                text-align: center;
                text-transform: uppercase;
                margin: 10px 0;
                border-radius: 5px;
                border: none;
            ">
            <div id="redeem-msg" style="height: 20px; margin-bottom: 10px; font-weight: bold;"></div>
            <button class="action-btn" onclick="redeemCodeAction()" style="background: linear-gradient(135deg, #f1c40f, #f39c12);">Claim</button>
        </div>
    </div>

    <!-- Game Guide Modal -->
    <div id="guide-modal" class="modal" style="max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <button class="modal-close" onclick="closeModal('guide-modal')">&times;</button>
        <h2>Farmer's Handbook</h2>
        
        <div class="guide-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;">
            <button class="tab-btn active" onclick="switchGuideTab('basics', this)">Basics</button>
            <button class="tab-btn" onclick="switchGuideTab('controls', this)">Controls</button>
            <button class="tab-btn" onclick="switchGuideTab('ui', this)">Interface</button>
            <button class="tab-btn" onclick="switchGuideTab('tips', this)">Tips & Features</button>
        </div>

        <div id="guide-content-basics" class="guide-section">
            <h3>üå± Getting Started</h3>
            <p>Welcome to your farm! Here is how to grow your empire:</p>
            <ul style="text-align: left; margin: 10px 20px;">
                <li><strong>Planting:</strong> Open the üè™ <b>Shop</b>, select <b>Plots</b> to place soil, then select <b>Seeds</b> to plant crops.</li>
                <li><strong>Harvesting:</strong> Wait for crops to grow. When ready, simply <b>Click</b> on them to harvest.</li>
                <li><strong>Selling:</strong> Open your üéí <b>Inventory</b> to sell crops for money, or use the üõí <b>Sell Mode</b> button to remove buildings.</li>
            </ul>
        </div>

        <div id="guide-content-controls" class="guide-section" style="display: none;">
            <h3>üéÆ Controls</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                <div>
                    <h4>Mouse</h4>
                    <ul>
                        <li><strong>Left Click:</strong> Select / Interact / Harvest</li>
                        <li><strong>Right Click + Drag:</strong> Pan Camera (Move view)</li>
                        <li><strong>Scroll Wheel:</strong> Zoom In / Out</li>
                    </ul>
                </div>
                <div>
                    <h4>Touch (Mobile)</h4>
                    <ul>
                        <li><strong>Tap:</strong> Interact</li>
                        <li><strong>One Finger Drag:</strong> Pan Camera</li>
                        <li><strong>Buttons:</strong> Zoom In / Out</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="guide-content-ui" class="guide-section" style="display: none;">
            <h3>üñ•Ô∏è Interface Guide</h3>
            <div style="text-align: left; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                <div><span style="font-size:20px">üè™</span> <strong>Shop:</strong> Buy seeds, buildings, and decorations.</div>
                <div><span style="font-size:20px">‚úã</span> <strong>Move Mode:</strong> Re-arrange your farm layout.</div>
                <div><span style="font-size:20px">üí≤</span> <strong>Sell Mode:</strong> Delete items for a partial refund.</div>
                <div><span style="font-size:20px">üéí</span> <strong>Inventory:</strong> View and sell your harvested crops.</div>
                <div><span style="font-size:20px">üë§</span> <strong>Profile:</strong> Check your stats and save progress.</div>
                <div><span style="font-size:20px">üéüÔ∏è</span> <strong>Codes:</strong> Redeem secret codes for rewards!</div>
                <div><span style="font-size:20px">üåç</span> <strong>Visit:</strong> Explore other players' farms.</div>
            </div>
        </div>

        <div id="guide-content-tips" class="guide-section" style="display: none;">
            <h3>üí° Pro Tips & Features</h3>
            <ul style="text-align: left; margin: 10px 20px;">
                <li><strong>Missions:</strong> Check the left sidebar for missions. Completing them grants Money, XP, and sometimes <b>Secret Codes</b>!</li>
                <li><strong>Upgrades:</strong> Click your <b>Main House</b> or Animal Buildings to upgrade them for efficiency.</li>
                <li><strong>Seasons & Weather:</strong> Crops may grow differently depending on the season and weather.</li>
                <li><strong>Expansion:</strong> Running out of space? Click üìê <b>Expand Farm</b> to buy more land!</li>
            </ul>
        </div>
    </div>

    <!-- Mission Complete Modal -->
    <div id="mission-complete-modal" class="modal" style="text-align: center; border: 4px solid #f1c40f;">
        <button class="modal-close" onclick="closeModal('mission-complete-modal')">&times;</button>
        <h2 style="color: #f1c40f; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin-bottom: 15px;">üéâ MISSION COMPLETE! üéâ</h2>
        <div id="mission-complete-content" style="margin: 20px 0; font-size: 18px; line-height: 1.6;">
            <!-- Content injected via JS -->
        </div>
        <div class="confetti-container"></div>
        <button class="action-btn" onclick="closeModal('mission-complete-modal')" style="background: linear-gradient(135deg, #2ecc71, #27ae60); padding: 10px 40px; font-size: 18px; margin-top: 10px; box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);">Awesome!</button>
    </div>

    <!-- Level Up Modal -->
    <div id="level-up-modal" class="modal" style="text-align: center; border: 4px solid #3498db; background: linear-gradient(135deg, #2c3e50, #2980b9); color: white;">
        <button class="modal-close" onclick="closeModal('level-up-modal')">&times;</button>
        <h2 style="color: #f1c40f; font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); margin-bottom: 10px;">LEVEL UP!</h2>
        <div style="font-size: 60px; margin: 10px 0;">‚≠ê</div>
        <div id="level-up-content" style="margin: 20px 0; font-size: 20px; line-height: 1.6;">
            <!-- Content injected via JS -->
        </div>
        <div class="confetti-container"></div>
        <button class="action-btn" onclick="closeModal('level-up-modal')" style="background: linear-gradient(135deg, #f1c40f, #f39c12); padding: 10px 40px; font-size: 18px; margin-top: 10px; box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4); color: #2c3e50; font-weight: bold;">Continue</button>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal" style="text-align: center; border: 4px solid #e74c3c; z-index: 10001; max-width: 400px;">
        <h2 id="confirmation-title" style="color: #e74c3c; font-size: 24px; margin-bottom: 15px;">Confirm Action</h2>
        <div id="confirmation-content" style="margin: 20px 0; font-size: 18px; color: #2c3e50;">
            Are you sure?
        </div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
            <button id="confirmation-cancel-btn" class="action-btn" style="background: #95a5a6; min-width: 100px;">Cancel</button>
            <button id="confirmation-ok-btn" class="action-btn" style="background: #e74c3c; min-width: 100px;">Confirm</button>
        </div>
    </div>

    <div id="notification-container"></div>
    
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="admin_panels.js"></script>
    <script src="storage.js"></script>
    <script src="game.js"></script>
    <script>
        let authMode = 'login';

        window.switchAuthMode = function(mode) {
            authMode = mode;
            
            // Update tab active state
            document.querySelectorAll('.auth-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.closest('.auth-tab').classList.add('active');
            
            // Show/hide form sections
            document.getElementById('login-form').style.display = mode === 'login' ? 'flex' : 'none';
            document.getElementById('create-form').style.display = mode === 'create' ? 'flex' : 'none';
            document.getElementById('reset-form').style.display = mode === 'reset' ? 'flex' : 'none';
            
            // Clear messages
            document.getElementById('auth-message').innerText = '';
            document.getElementById('create-message').innerText = '';
            document.getElementById('reset-message').innerText = '';
        };

        window.handleAuthSubmit = function() {
            const u = document.getElementById('auth-username').value.trim();
            const p = document.getElementById('auth-password').value.trim();
            const msg = document.getElementById('auth-message');
            
            if(!u || !p) {
                msg.classList.remove('success');
                msg.innerText = "Please enter username and password";
                return;
            }
            
            console.log('Login attempt for user:', u);
            
            // Try to use game.js function first, fallback to localStorage
            if (window.gameLogin) {
                try {
                    const result = window.gameLogin(u, p);
                    console.log('gameLogin result:', result);
                    if (result.success) {
                        msg.classList.add('success');
                        msg.innerText = "‚úì Login successful! Loading...";
                        // Store current player
                        localStorage.setItem('currentPlayer', u);
                        // gameLogin internally calls loadUserSave and rebuildSceneFromState
                        // Just need to start the game loop and show UI
                        setTimeout(() => {
                            try {
                                console.log('Current player:', localStorage.getItem('currentPlayer'));
                                console.log('Game state player name:', typeof gameState !== 'undefined' ? gameState.playerName : 'gameState not defined');
                                
                                // Ensure updateUI is called to show buttons
                                if (typeof window.updateUI === 'function') {
                                    console.log('Calling window.updateUI()');
                                    window.updateUI();
                                } else {
                                    console.warn('window.updateUI not available');
                                }
                                startGameUI();
                            } catch(e) {
                                console.error('Error in post-login UI setup:', e);
                                msg.innerText = "Error loading UI: " + e.message;
                            }
                        }, 500);
                    } else {
                        msg.classList.remove('success');
                        msg.innerText = result.message || "Login failed";
                    }
                } catch(e) {
                    console.error('Login error:', e);
                    msg.classList.remove('success');
                    msg.innerText = "Error: " + e.message;
                }
            } else {
                console.log('window.gameLogin not available, using localStorage fallback');
                // Fallback: Direct localStorage check
                const users = JSON.parse(localStorage.getItem('farmSimUsers') || '{}');
                console.log('Available users:', Object.keys(users));
                if (users[u] && users[u] === p) {
                    msg.classList.add('success');
                    msg.innerText = "‚úì Login successful! Loading...";
                    localStorage.setItem('currentPlayer', u);
                    // Initialize game if not done yet
                    if (!window.renderer || !window.scene) {
                        if (window.initGame) {
                            window.initGame(u);
                        }
                    }
                    // Just transition to game UI - game.initGame already loads saves
                    setTimeout(() => {
                        try {
                            startGameUI();
                        } catch(e) {
                            console.error('Error in post-login UI setup:', e);
                            msg.innerText = "Error loading UI: " + e.message;
                        }
                    }, 800);
                } else {
                    msg.classList.remove('success');
                    msg.innerText = users[u] ? "Incorrect password" : "User not found. Please Create Account.";
                }
            }
        };

        window.handleCreateAccount = function() {
            const u = document.getElementById('create-username').value.trim();
            const e = document.getElementById('create-email').value.trim();
            const p = document.getElementById('create-password').value.trim();
            const c = document.getElementById('create-confirm').value.trim();
            const msg = document.getElementById('create-message');
            
            if(!u || !e || !p || !c) {
                msg.classList.remove('success');
                msg.innerText = "Please fill in all fields";
                return;
            }
            
            if(!e.includes('@')) {
                msg.classList.remove('success');
                msg.innerText = "Please enter a valid email";
                return;
            }
            
            if(p.length < 6) {
                msg.classList.remove('success');
                msg.innerText = "Password must be at least 6 characters";
                return;
            }
            
            if(p !== c) {
                msg.classList.remove('success');
                msg.innerText = "Passwords do not match";
                return;
            }
            
            if (window.gameCreateAccount) {
                try {
                    const result = window.gameCreateAccount(u, p);
                    if (result.success) {
                        msg.classList.add('success');
                        msg.innerText = "‚úì Account created! Logging in...";
                        // Store email for account recovery
                        localStorage.setItem(`email_${u}`, e);
                        localStorage.setItem('currentPlayer', u);
                        // gameCreateAccount internally calls initFreshState and rebuildSceneFromState
                        setTimeout(() => {
                            startGameUI();
                        }, 600);
                    } else {
                        msg.classList.remove('success');
                        msg.innerText = result.message;
                    }
                } catch(e) {
                    console.error('Create account error:', e);
                    msg.classList.remove('success');
                    msg.innerText = "Error: " + e.message;
                }
            } else {
                // Fallback: Direct localStorage create
                const users = JSON.parse(localStorage.getItem('farmSimUsers') || '{}');
                if (users[u]) {
                    msg.classList.remove('success');
                    msg.innerText = "Username already exists";
                    return;
                }
                users[u] = p;
                localStorage.setItem('farmSimUsers', JSON.stringify(users));
                localStorage.setItem(`email_${u}`, e);
                localStorage.setItem('currentPlayer', u);
                msg.classList.add('success');
                msg.innerText = "‚úì Account created! Logging in...";
                // Initialize game if not done
                if (!window.renderer || !window.scene) {
                    if (window.initGame) {
                        window.initGame(u);
                    }
                }
                // Transition to game UI
                setTimeout(() => {
                    startGameUI();
                }, 600);
            }
        };

        window.handleResetPassword = function() {
            const u = document.getElementById('reset-username').value.trim();
            const e = document.getElementById('reset-email').value.trim();
            const msg = document.getElementById('reset-message');
            
            if(!u || !e) {
                msg.classList.remove('success');
                msg.innerText = "Please enter both username and email";
                return;
            }
            
            if(!e.includes('@')) {
                msg.classList.remove('success');
                msg.innerText = "Please enter a valid email";
                return;
            }
            
            // Verify email matches
            const storedEmail = localStorage.getItem(`email_${u}`);
            if(storedEmail && storedEmail !== e) {
                msg.classList.remove('success');
                msg.innerText = "Email does not match username";
                return;
            }
            
            if (window.gameResetPassword) {
                try {
                    const tempPassword = 'temp_' + Math.random().toString(36).substr(2, 9);
                    const result = window.gameResetPassword(u, tempPassword);
                    if (result.success) {
                        msg.classList.add('success');
                        msg.innerText = "‚úì Password reset! New password: " + tempPassword;
                        // Store reset info
                        localStorage.setItem(`reset_${u}`, Date.now().toString());
                        setTimeout(() => window.switchAuthMode('login'), 3000);
                    } else {
                        msg.classList.remove('success');
                        msg.innerText = result.message || "Reset failed";
                    }
                } catch(e) {
                    console.error('Reset password error:', e);
                    msg.classList.remove('success');
                    msg.innerText = "Error: " + e.message;
                }
            } else {
                // Fallback: Direct localStorage reset
                const users = JSON.parse(localStorage.getItem('farmSimUsers') || '{}');
                if (!users[u]) {
                    msg.classList.remove('success');
                    msg.innerText = "User not found";
                    return;
                }
                const tempPassword = 'temp_' + Math.random().toString(36).substr(2, 9);
                users[u] = tempPassword;
                localStorage.setItem('farmSimUsers', JSON.stringify(users));
                localStorage.setItem(`reset_${u}`, Date.now().toString());
                msg.classList.add('success');
                msg.innerText = "‚úì Password reset! New password: " + tempPassword;
                setTimeout(() => window.switchAuthMode('login'), 3000);
            }
        };

        function startGameUI() {
            try {
                console.log('Starting game UI...');
                const currentPlayer = localStorage.getItem('currentPlayer');
                console.log('Current player from storage:', currentPlayer);
                
                // Hide login, show game
                const startScreen = document.getElementById('start-screen');
                const uiLayer = document.getElementById('ui-layer');
                if (startScreen) {
                    startScreen.style.display = 'none';
                    console.log('Login screen hidden');
                }
                if (uiLayer) {
                    uiLayer.style.display = 'block';
                    console.log('Game UI layer shown');
                }
                
                // Update UI to show buttons and player info
                if (typeof window.updateUI === 'function') {
                    try {
                        console.log('Calling window.updateUI() from startGameUI');
                        window.updateUI();
                        console.log('UI updated with player info and button visibility');
                    } catch(e) {
                        console.warn('Error calling window.updateUI:', e);
                    }
                } else {
                    console.warn('window.updateUI not available in startGameUI');
                }
                
                // Start animation loop
                if (window.startGame) {
                    window.startGame();
                    console.log('Game animation loop started');
                } else {
                    console.warn('window.startGame not available');
                }
                
                // Show tutorial for new players (after a short delay to ensure UI is ready)
                if (currentPlayer) {
                    const playerTutorialKey = `tutorial_${currentPlayer}`;
                    if (!localStorage.getItem(playerTutorialKey)) {
                        setTimeout(() => {
                            if (window.showTutorial) {
                                window.showTutorial();
                                console.log('Tutorial shown for new player');
                            }
                            localStorage.setItem(playerTutorialKey, 'true');
                        }, 1500);
                    }
                }
                
                console.log('Game UI setup complete');
            } catch (e) {
                console.error('Error in startGameUI:', e);
                const msg = document.getElementById('auth-message');
                if (msg) {
                    msg.innerText = "Error starting game: " + e.message;
                }
            }
        }

        window.addEventListener('load', () => {
            // Set Version
            const vEl = document.getElementById('version-display');
            if (vEl) {
                vEl.innerText = "v2.0 - Weather Update";
            }

            // Ensure default users and roles are created
            if (window.ensureDefaultAdmins) {
                try {
                    window.ensureDefaultAdmins();
                } catch(e) {
                    console.warn('Could not ensure default admins:', e);
                }
            }

            // Init background scene (preview mode)
            if (window.initGame) {
                window.initGame(null);
            }

            // Focus input
            const input = document.getElementById('auth-username');
            if(input) {
                input.focus();
                // Prevent event bubbling issues
                ['pointerdown', 'mousedown', 'click', 'touchstart'].forEach(evt => {
                    input.addEventListener(evt, (e) => e.stopPropagation());
                });
                const pInput = document.getElementById('auth-password');
                ['pointerdown', 'mousedown', 'click', 'touchstart'].forEach(evt => {
                    pInput.addEventListener(evt, (e) => e.stopPropagation());
                });
            }
        });

        // Removed old startGameClick
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showLeaderboard() {
            document.getElementById('leaderboard-modal').style.display = 'block';
            if(window.refreshLeaderboard) window.refreshLeaderboard();
        }

        function showUpdates() {
            document.getElementById('updates-modal').style.display = 'block';
        }

        function showWorldMap() {
            document.getElementById('world-map-modal').style.display = 'block';
            if(window.refreshFarmList) window.refreshFarmList();
        }
        
        function returnHome() {
            if(window.loadHomeFarm) window.loadHomeFarm();
        }
        
        function showProfile() {
            const el = document.getElementById('profile-modal');
            el.style.display = 'block';
            if (window.refreshProfile) window.refreshProfile();
        }
        function showInventory() {
            const el = document.getElementById('inventory-modal');
            el.style.display = 'block';
            if (window.refreshInventory) window.refreshInventory();
        }

        function toggleMissions() {
            const content = document.getElementById('mission-content');
            content.classList.toggle('expanded');
        }

        // AI Chat Support Functions
        const aiResponses = {
            'best crops': 'üåæ For maximum profit, plant: Watermelon (30m), Sunflower (20m), or Corn (25m). High-value crops take longer but pay more!',
            'crops money': 'üí∞ Plant expensive crops like Watermelon, Sunflower, or Corn for big earnings. Sell multiple plots together for more cash!',
            'how to get diamonds': 'üíé Diamonds come from: Daily rewards, completing missions, selling rare items, or watching videos. Check your mission list!',
            'animal breeding': 'üêî Build a Breeding Center, place animals inside, wait for breeding cooldown, and you\'ll get baby animals! Each animal type breeds differently.',
            'fast money': '‚ö° Plant Wheat (fast grow) repeatedly. Or collect from animal buildings. Combine with decorations for +10% boost!',
            'expand farm': 'üìê Click the Expand button (üìê) to buy more land. You unlock new items each time you expand!',
            'storage': 'üì¶ Build Silos and Warehouses to store crops. Multiple buildings stack their capacity for more storage!',
            'power': '‚ö° Build Generators and Solar panels for electricity. Use power for faster growth on some crops!',
            'hello': 'üëã Hello farmer! How can I help you today? Ask about crops, animals, buildings, or ways to make money!',
            'help': 'üÜò I can help with: crops, money tips, animals, buildings, storage, expansion, and more! What would you like to know?'
        };

        window.sendAIMessage = function() {
            const input = document.getElementById('ai-chat-input');
            const messagesDiv = document.getElementById('ai-chat-messages');
            const userMessage = input.value.trim().toLowerCase();
            
            if (!userMessage) return;
            
            // Add user message
            const userMsgDiv = document.createElement('div');
            userMsgDiv.style.cssText = 'background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; text-align: left; align-self: flex-end; max-width: 80%;';
            userMsgDiv.innerHTML = `<strong style="color: #ecf0f1;">You:</strong> ${userMessage}`;
            messagesDiv.appendChild(userMsgDiv);
            
            // Use improved backend processor if available
            let aiResponse = null;
            try {
                if (window.processAIQuery) aiResponse = window.processAIQuery(userMessage);
            } catch(e) { console.warn('processAIQuery failed', e); }
            if (!aiResponse) {
                aiResponse = 'üí¨ I\'m not sure about that. Try asking about crops, animals, money, buildings, or expansion!';
                for (let key in aiResponses) {
                    if (userMessage.includes(key)) {
                        aiResponse = aiResponses[key];
                        break;
                    }
                }
            }

            // Add AI response with delay
            setTimeout(() => {
                const aiMsgDiv = document.createElement('div');
                aiMsgDiv.style.cssText = 'background: rgba(102, 126, 234, 0.2); padding: 10px; border-radius: 10px; text-align: left;';
                aiMsgDiv.innerHTML = `<strong style="color: #667eea;">ü§ñ AI:</strong> ${aiResponse}`;
                messagesDiv.appendChild(aiMsgDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 300);
            
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        // Allow Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            const aiInput = document.getElementById('ai-chat-input');
            if (aiInput) {
                aiInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') window.sendAIMessage();
                });
            }
        });

        // Tutorial Functions
        let currentTutorialStep = 1;
        const totalTutorialSteps = 7;

        window.showTutorial = function() {
            currentTutorialStep = 1;
            updateTutorialStep();
            document.getElementById('tutorial-modal').style.display = 'block';
        };

        window.closeTutorial = function() {
            document.getElementById('tutorial-modal').style.display = 'none';
            localStorage.setItem('tutorial_completed', 'true');
        };

        window.nextTutorialStep = function() {
            if (currentTutorialStep < totalTutorialSteps) {
                currentTutorialStep++;
                updateTutorialStep();
            } else {
                closeTutorial();
            }
        };

        window.previousTutorialStep = function() {
            if (currentTutorialStep > 1) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        };

        function updateTutorialStep() {
            // Hide all steps
            for (let i = 1; i <= totalTutorialSteps; i++) {
                const step = document.getElementById(`tutorial-step-${i}`);
                if (step) step.style.display = 'none';
            }
            
            // Show current step
            const currentStep = document.getElementById(`tutorial-step-${currentTutorialStep}`);
            if (currentStep) currentStep.style.display = 'block';
            
            // Update progress
            document.getElementById('tutorial-progress').innerText = `${currentTutorialStep} / ${totalTutorialSteps}`;
            
            // Update button states
            document.getElementById('tutorial-prev-btn').disabled = currentTutorialStep === 1;
            document.getElementById('tutorial-next-btn').innerText = currentTutorialStep === totalTutorialSteps ? '‚úì Finish' : 'Next ‚û°Ô∏è';
        }

        // Show tutorial for new players
        window.showGameGuide = function() {
            showTutorial();
        };

        // Check if tutorial should be shown on first load
        if (!localStorage.getItem('tutorial_completed') && !localStorage.getItem('gameData')) {
            // New player - show tutorial on first login
            setTimeout(() => {
                // Will be shown after game init
            }, 2000);
        }
    </script>
        <!-- NPC / Pending Pickups Panel -->
        <div id="npc-panel" class="ui-panel" style="position: absolute; bottom: 20px; left: 20px; width: 300px; z-index: 1200; pointer-events: auto; display: none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <strong style="font-size:14px;">Farm Hands</strong>
                <button id="npc-panel-toggle" class="round-hud-btn" style="width:32px;height:32px; border-radius:8px; font-size:14px;">‚ñæ</button>
            </div>
            <div id="pending-list" style="max-height:120px; overflow:auto; gap:6px; display:flex; flex-direction:column; margin-bottom:8px;"></div>
            <hr style="border:none; height:1px; background:rgba(255,255,255,0.08); margin:6px 0;">
            <div id="npc-list" style="max-height:120px; overflow:auto; gap:6px; display:flex; flex-direction:column;"></div>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button id="npc-demo-btn" class="btn">Demo Pickup</button>
                <button id="npc-clear-btn" class="btn">Clear Pending</button>
            </div>
        </div>
</body>
</html>

